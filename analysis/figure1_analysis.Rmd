---
title: "figure 1"
output:
  workflowr::wflow_html:
    code_folding: hide
    toc: true
date: "2026-02-06"
---



```{r, message=F, warning=F}
rm(list=ls())
library(rprojroot)
library(dplyr)
root <- rprojroot::find_rstudio_root_file()
```


```{r, message=F, warning=F}
union_peak_reads_count=read.delim((file.path(root, "../Data/Novogene/PeakWindows/Cere_union_peak_read_counts.tsv")), header=T, stringsAsFactors = FALSE)
dim(union_peak_reads_count)
head(union_peak_reads_count)
```


* in total 237,934 union peak windows 


```{r, message=F, warning=F}
#if (!require("BiocManager", quietly = TRUE))
#    install.packages("BiocManager")

#BiocManager::install("DESeq2")


#if (!require("BiocManager", quietly = TRUE))
#    install.packages("BiocManager")

#BiocManager::install("apeglm")




library(DESeq2)
library(apeglm)

# ----------------------------
# Prepare count matrix
# ----------------------------
count_mat <- as.matrix(
  union_peak_reads_count[, c("C1", "C2", "K1", "K2")]
)

rownames(count_mat) <- paste(
  union_peak_reads_count$chr,
  union_peak_reads_count$start,
  union_peak_reads_count$end,
  sep = ":"
)

# Ensure integer mode (important for DESeq2)
storage.mode(count_mat) <- "integer"

# ----------------------------
# Sample metadata
# ----------------------------
coldata <- data.frame(
  condition = c("C", "C", "K", "K"),
  row.names = colnames(count_mat)
)

# ----------------------------
# Create DESeq2 object
# ----------------------------
dds1 <- DESeqDataSetFromMatrix(
  countData = count_mat,
  colData   = coldata,
  design    = ~ condition
)
sizeFactors(dds1)

# ----------------------------
# Optional but recommended: filter low counts
# ----------------------------
#keep <- rowSums(counts(dds)) >= 10
#dds <- dds[keep, ]

# ----------------------------
# Run DESeq2
# ----------------------------
dds2 <- DESeq(dds1)
sizeFactors(dds2)

# ----------------------------
# Results: K vs C
# ----------------------------
res <- results(dds2, contrast = c("condition", "K", "C"))

head(res)

# Shrink log2FC (recommended for ATAC-seq)
#res_shrunk <- lfcShrink(
#  dds,
#  contrast = c("condition", "K", "C"),
#  type = "apeglm"
#)

# Order by adjusted p-value
#res_shrunk <- res_shrunk[order(res_shrunk$padj), ]
#
#head(res_shrunk)

```

* K: Cre, Bmal1-deficient  and C: FIx, wild-type 

* log2FoldChange:  Cre vs FIx 

$$baseMean=\frac{1}{n}\sum_{i=1}^n\frac{C_{ij}}{s_i}=\frac{1}{n}\sum_{i=1}^nC^*_{ij}$$
$C_{ij}$ is the raw count in peak $j$ and sample $i$.  $s_i$ is the size factor for sample i. $C^*_{ij}$ is the normalized count. 


* $$log2FoldChange=log_2\frac{average~C^*_{ij}~in~group~k}{average~C^*_{ij}~in~group~c}$$





```{r, message=F, warning=F, eval=F}
################# calculate size factor ########################
# 1. Calculate the Geometric Mean for each row (the pseudo-reference)
# We use log to avoid overflow with large products
geom_means <- exp(rowMeans(log(count_mat)))

# 2. Filter out zeros
# Geometric mean is 0 if any sample has 0. DESeq2 only uses rows where 
# the geometric mean is > 0 to calculate size factors.
count_mat_filtered <- count_mat[geom_means > 0, ]
geom_means_filtered <- geom_means[geom_means > 0]

# 3. Calculate the ratios for each peak
# Divide each sample's counts by the geometric mean reference
ratios <- count_mat_filtered / geom_means_filtered

# 4. Find the Median of the ratios for each sample
# This is your manual Size Factor
manual_size_factors <- apply(ratios, 2, median)

# Compare with DESeq2 results
print("Manual Size Factors:")
print(manual_size_factors)

print("DESeq2 Size Factors:")
print(sizeFactors(dds2))
```


```{r, message=F, warning=F}
library(dplyr)
library(ggplot2)


log2FC_cut <- 0.58
pval_cut   <- 0.05


library(dplyr)

plot_df <- as.data.frame(res) %>%
  mutate(
    mean_expr = baseMean,
    neglogp   = -log10(pvalue),
    Typechange = case_when(
      pvalue < pval_cut & log2FoldChange >=  log2FC_cut  ~ "Strengthened",
      pvalue < pval_cut & log2FoldChange <= -log2FC_cut  ~ "Weakened",
      TRUE                                               ~ "Unchanged"
    )
  )
plot_df$neglogp <- pmin(plot_df$neglogp, 15)


```



```{r, message=F, warning=F}

ggplot(plot_df, aes(x = mean_expr, y = log2FoldChange)) +
  geom_point(
    aes(color = Typechange, size = neglogp),
    alpha = 0.6
  ) +
  scale_x_log10() +
  geom_hline(yintercept = 0, color = "blue", linewidth = 1) +
  geom_hline(
    yintercept = c(-log2FC_cut, log2FC_cut),
    linetype = "dashed",
    color = "black"
  ) +
  scale_color_manual(
    values = c(
      "Strengthened"   = "#F8766D",
      "Weakened"     = "#00BA38",
      "Unchanged" = "#619CFF"
    )
  ) +
  scale_size_continuous(
    range = c(1, 6),
    name = "-log10(pvalue)"
  ) +
  labs(title = "log2FC_cut: 0.58, pval_cut: 0.05",
    x = "BaseMean",
    #y = "Log2(Fold Change)",
    y=expression(paste(log[2]("Fold Change"))),
    color = "Typechange"
  ) +
  theme_bw(base_size = 14) +
  theme(
    panel.grid.major = element_line(color = "grey90"),
    panel.grid.minor = element_blank()
  )
plot_df %>% 
  dplyr::count(Typechange)


```



```{r, message=F, warning=F}
#################### normalize counts 

# variance-stabilizing transform
vsd <- vst(dds1, blind = TRUE)

mat <- assay(vsd)

mat_scaled <- t(scale(t(mat)))


# keep only peaks in matrix
res <- res[rownames(mat_scaled), ]

```


```{r, message=F, warning=F}
# ----------------------------
# Apply significance cutoffs
# ----------------------------
res_filt <- res[
  !is.na(res$pvalue) &
  res$pvalue < pval_cut &
  abs(res$log2FoldChange) >= log2FC_cut,
]

# Order by effect size
res_filt <- res_filt[
  order(abs(res_filt$log2FoldChange), decreasing = TRUE),
]

# Limit size (prevents clustering crash)
#topN <- min(5000, nrow(res_filt))
#res_filt <- res_filt[1:topN, , drop = FALSE]

# ----------------------------
# Subset matrix (CRITICAL drop=FALSE)
# ----------------------------
mat_filt <- mat_scaled[rownames(res_filt), , drop = FALSE]

strengthened <- res_filt$log2FoldChange > 0
weakened   <- res_filt$log2FoldChange < 0

mat_strengthened <- mat_filt[strengthened, , drop = FALSE]
mat_weakened   <- mat_filt[weakened,   , drop = FALSE]

mat_ordered <- rbind(mat_strengthened, mat_weakened)
colnames(mat_ordered)
colnames(mat_ordered) <- c("FIx1", "FIx2", "Cre1", "Cre2")

```


```{r, message=F, warning=F}


library(pheatmap)

pheatmap(
  mat_ordered,
  color = colorRampPalette(c("green", "white", "red"))(100),
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  show_rownames = FALSE,
  show_colnames = TRUE,
  border_color = NA,
  gaps_row = nrow(mat_strengthened),
  fontsize_col = 12, 
  main = "Heatmap: log2FC_cut: 0.58, pval_cut: 0.05"
)

```




```{r, message=F, warning=F}

#if (!require("BiocManager", quietly = TRUE))
#    install.packages("BiocManager")
#
#BiocManager::install("ChIPseeker")



#if (!require("BiocManager", quietly = TRUE))
#    install.packages("BiocManager")

#BiocManager::install("TxDb.Mmusculus.UCSC.mm10.knownGene")

#BiocManager::install("org.Mm.eg.db")

# 1. Load necessary libraries
library(ChIPseeker)
library(TxDb.Mmusculus.UCSC.mm10.knownGene)
library(org.Mm.eg.db)
library(GenomicRanges)
library(ggplot2)
library(tidyr)

# 2. Prepare the data
# Extract coordinates from the rownames (e.g., "chr1:3128676:3128999")

prepare_data_for_peak_distribution=function(plot_df)
{

regions_split <- do.call(rbind, strsplit(rownames(plot_df), ":"))
peaks_gr <- GRanges(
  seqnames = regions_split[,1],
  ranges = IRanges(start = as.numeric(regions_split[,2]), 
                   end = as.numeric(regions_split[,3]))
)

# 3. Annotate peaks relative to TSS
txdb <- TxDb.Mmusculus.UCSC.mm10.knownGene
peakAnno <- annotatePeak(peaks_gr, tssRegion=c(-3000, 3000), 
                         TxDb=txdb, annoDb="org.Mm.eg.db")

# 4. Extract distance data and create custom bins
# Convert distance from bp to kb
dist_data <- as.data.frame(peakAnno) %>%
  mutate(dist_kb = distanceToTSS / 1000)

# Define the breaks and labels exactly as seen in the image
ordered_levels <- c("<-500", "-500 to -50", "-50 to -5", "-5 to 0", 
                    "0 to 5", "5 to 50", "50 to 500", ">500")

plot_ready <- dist_data %>%
  mutate(bin = cut(dist_kb, 
                   breaks = c(-Inf, -500, -50, -5, 0, 5, 50, 500, Inf), 
                   labels = ordered_levels, 
                   include.lowest = TRUE)) %>%
  # Ensure the factor levels follow our custom order
  mutate(bin = factor(bin, levels = ordered_levels)) %>%
  group_by(bin) %>%
  summarise(count = n()) %>%
  complete(bin = factor(ordered_levels, levels = ordered_levels), 
           fill = list(count = 0)) %>%
  mutate(percentage = count / sum(count))

return(plot_ready)
}

plot_ready=prepare_data_for_peak_distribution(plot_df %>% filter(Typechange=="Strengthened"))
sum(plot_ready$count)
```


```{r, message=F, warning=F}
ggplot(plot_ready, aes(x = bin, y = percentage)) +
  geom_bar(stat = "identity", fill = "blue", color = "black", width = 0.7) +
  
  # Add "Strengthened" to the top left corner
  # x = 0.5 pushes it to the far left margin; hjust = 0 aligns it to the left
  annotate("text", x = 0.5, y = 0.38, label = "Strengthened", 
           fontface = "bold", size = 5, hjust = 0) +
  
  # Numbers moved further above the bars
  geom_text(aes(label = count), vjust = -1.5, size = 3.5) +
  
  # Shortened TSS vertical line (ending at y=0.29)
  # x = 4.5 sits between "-5 to 0" and "0 to 5"
  annotate("segment", x = 4.5, xend = 4.5, y = 0.01, yend = 0.29, 
           linewidth = 0.5, color = "black") +
  
  # TSS Horizontal Arrow
  annotate("segment", x = 4.5, xend = 5.2, y = 0.29, yend = 0.29, 
           arrow = arrow(length = unit(0.1, "cm")), linewidth = 0.5) +
  
  # TSS Text Label
  annotate("text", x = 4.85, y = 0.31, label = "TSS", size = 4) +
  
  # Styling
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), 
                     limits = c(0, 0.40), expand = c(0,0)) +
  labs(x = "Distance to TSS (kb)", y = "Region-gene associations", title="Genomic location") +
  theme_bw() +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
    axis.title = element_text(size = 12),
    plot.margin = margin(1, 1, 1, 1, "cm"), 
    plot.title = element_text(hjust = 0.5)   # center the title 
  )
```


```{r, message=F, warning=F}
plot_ready=prepare_data_for_peak_distribution(plot_df %>% filter(Typechange=="Weakened"))
sum(plot_ready$count)

ggplot(plot_ready, aes(x = bin, y = percentage)) +
  geom_bar(stat = "identity", fill = "blue", color = "black", width = 0.7) +
  
  # Add "Strengthened" to the top left corner
  # x = 0.5 pushes it to the far left margin; hjust = 0 aligns it to the left
  annotate("text", x = 0.5, y = 0.38, label = "Weakened", 
           fontface = "bold", size = 5, hjust = 0) +
  
  # Numbers moved further above the bars
  geom_text(aes(label = count), vjust = -1.5, size = 3.5) +
  
  # Shortened TSS vertical line (ending at y=0.29)
  # x = 4.5 sits between "-5 to 0" and "0 to 5"
  annotate("segment", x = 4.5, xend = 4.5, y = 0.01, yend = 0.29, 
           linewidth = 0.5, color = "black") +
  
  # TSS Horizontal Arrow
  annotate("segment", x = 4.5, xend = 5.2, y = 0.29, yend = 0.29, 
           arrow = arrow(length = unit(0.1, "cm")), linewidth = 0.5) +
  
  # TSS Text Label
  annotate("text", x = 4.85, y = 0.31, label = "TSS", size = 4) +
  
  # Styling
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), 
                     limits = c(0, 0.40), expand = c(0,0)) +
  labs(x = "Distance to TSS (kb)", y = "Region-gene associations", title="Genomic location") +
  theme_bw() +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
    axis.title = element_text(size = 12),
    plot.margin = margin(1, 1, 1, 1, "cm"), 
    plot.title = element_text(hjust = 0.5)   # center the title 
  )
```




```{r, message=F, warning=F, eval=F}
# Function to convert your matrix rownames (chr:start:end) to BED format
export_bed <- function(mat, filename) {
  # Split the "chr:start:end" strings
  coords <- do.call(rbind, strsplit(rownames(mat), ":"))
  # Create a data frame
  bed_data <- data.frame(
    chrom = coords[,1],
    start = coords[,2],
    end   = coords[,3]
  )
  # Write to file (Tab-separated, no headers)
  write.table(bed_data, filename, sep="\t", quote=F, row.names=F, col.names=F)
}

# Export your two groups
#export_bed(mat_strengthened, file.path(root, "../Data/Novogene/PeakWindows/Cre_strengthened.bed"))
#export_bed(mat_weakened, file.path(root, "../Data/Novogene/PeakWindows/Cre_weakened.bed"))
```